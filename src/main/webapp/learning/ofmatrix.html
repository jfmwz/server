<!DOCTYPE html>
<html>
<body class="lift:content_id=main">
<div id="main" class="lift:surround?with=default;at=content">
  <head_merge>
    <script type="text/javascript" src="/static/canvas3DGraph.js"></script>
    <!--<script type="text/javascript" src="/static/build_ofmatrix.js"></script>-->
    <script type="text/javascript">
      $(document).ready(function() {
        "use strict";
        loadOFMatrix("build_matrix")
      });

      /**
       *
       * @param {Array} data
       * @param val
       * @param init
       * @return {*}
       */
      function max(data, val, init) {
        data.forEach(function(o) {
          var x = o[val];
          if (x > init) init = x;
        });
        return init;
      }

      /**
       *
       * @param {Array} data
       * @return {Array}
       */
      function calc_header(data) {
        "use strict";
        var x = {};
        data.forEach(function(o) {
          x[o.ef] = 1
        });
        var arr = [];
        for (var ef in x) {
          arr.push(ef);
        }
        arr.sort();
        return arr;
      }


      function renderHeader(hdrs) {
        var el = document.createElement("tr");
        hdrs.forEach(function(o) {
          $(el).append('<td>' + o + '</td>')
        });
        return el;
      }

      /**
       *
       * @param {Array} data
       * @param {int} n
       * @param mapper
       */
      function renderRow(data, n, mapper) {
        var row = document.createElement("tr");
        for (var i = 0; i < mapper.length; ++i) {
          row.appendChild(document.createElement("td"))
        }

        data.filter(function(o) {
          return o.n == n;
        }).forEach(function(o){
          "use strict";
          var idx = mapper.indexOf(o.ef.toString());
          row.children[idx].innerText = o.val.toFixed(2)
        });

        return row;
      }

      function build_ofmatrix(elem, data) {
        "use strict";
        var obj = calc_header(data);
        var maxn = max(data, "n", 0);

        var tbl = $("#data-table");
        tbl.append(renderHeader(obj));
        for( var n = 1; n <= maxn; ++n) {
          tbl.append(renderRow(data, n, obj));
        }
      }


      function build_matrix(data) {
        "use strict";

        build_ofmatrix('data-table', data);

        var toDraw = [];
        for (var i = 0; i < data.length; ++i) {
          var o = data[i];
          var mod = {x:o.ef - 1.2, y:o.n, z:o.val};
          toDraw.push(mod);
        }
        toDraw.sort(sortNumByZ);
        var g = new canvasGraph('graph');
        g.xMax = max(toDraw, "x", 0) * 1.1;
        g.yMax = max(toDraw, "y", 0) * 1.1;
        g.zMax = max(toDraw, "z", 0) * 1.1;
        g.drawInfo();
        g.drawGraph(toDraw);
      }
    </script>
    <script type="text/javascript" class="lift:OFMatrix.dataScript">
      function loadOFMatrix(callback) {}
    </script>
  </head_merge>
  <h3>Your OF Matrix</h3>
  <div>
    <div id="canvas-div">
      <canvas id="graph" width="600" height="600"></canvas>
      <div id="gInfo"></div>
    </div>
  </div>
  <div >
    <table id="data-table">
    </table>
  </div>
</div>
</body>
</html>

